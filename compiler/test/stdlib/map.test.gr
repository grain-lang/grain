import Map from "map";
import List from "list";
import Array from "array";

// Data types used in multiple tests
enum Resource { Grain, Sheep, Brick, Wood };
record ResourceData { name: String, emoji: String }

// Map.isEmpty()

let e = Map.make();

assert Map.isEmpty(e);
Map.set("ðŸŒ¾", "ðŸŒ¾", e);
assert !Map.isEmpty(e);

// Map.size()

let s = Map.make();

Map.set("ðŸŒ¾", 1, s);
Map.set("ðŸ‘", 2, s);
Map.set("ðŸ§±", 3, s);

assert Map.size(s) == 3;

// Map.clear()

let c = Map.make();

Map.set("ðŸŒ¾", 1, c);
Map.set("ðŸ‘", 2, c);
Map.set("ðŸ§±", 3, c);

assert !Map.isEmpty(c);

assert Map.clear(c) == void;

assert Map.isEmpty(c);

// Map.contains()

let h = Map.make();

Map.set("ðŸŒ¾", 1, h);
Map.set("ðŸ‘", 2, h);
Map.set("ðŸ§±", 3, h);

assert Map.contains("ðŸŒ¾", h);
assert Map.contains("ðŸ‘", h);
assert Map.contains("ðŸ§±", h);
assert !Map.contains("ðŸŒ³", h);

// Map.set() & Map.get()

// With Number keys
let nums = Map.make();

assert Map.set(1, "ðŸŒ¾", nums) == void;
assert Map.set(2, "ðŸ‘", nums) == void;
assert Map.set(3, "ðŸ§±", nums) == void;

assert Map.get(1, nums) == Some("ðŸŒ¾");
assert Map.get(2, nums) == Some("ðŸ‘");
assert Map.get(3, nums) == Some("ðŸ§±");
assert Map.get(4, nums) == None;

// With String keys
let strs = Map.make();

assert Map.set("ðŸŒ¾", 1, strs) == void;
assert Map.set("ðŸ‘", 2, strs) == void;
assert Map.set("ðŸ§±", 3, strs) == void;

assert Map.get("ðŸŒ¾", strs) == Some(1);
assert Map.get("ðŸ‘", strs) == Some(2);
assert Map.get("ðŸ§±", strs) == Some(3);
assert Map.get("ðŸŒ³", strs) == None;

// With variant keys
let vars = Map.make();

assert Map.set(Grain, "ðŸŒ¾", vars) == void;
assert Map.set(Sheep, "ðŸ‘", vars) == void;
assert Map.set(Brick, "ðŸ§±", vars) == void;

assert Map.get(Grain, vars) == Some("ðŸŒ¾");
assert Map.get(Sheep, vars) == Some("ðŸ‘");
assert Map.get(Brick, vars) == Some("ðŸ§±");
assert Map.get(Wood, vars) == None;

// With record keys
let recs = Map.make();

assert Map.set({ name: "Grain", emoji: "ðŸŒ¾" }, 1, recs) == void;
assert Map.set({ name: "Sheep", emoji: "ðŸ‘" }, 2, recs) == void;
assert Map.set({ name: "Brick", emoji: "ðŸ§±" }, 3, recs) == void;

assert Map.get({ name: "Grain", emoji: "ðŸŒ¾" }, recs) == Some(1);
assert Map.get({ name: "Sheep", emoji: "ðŸ‘" }, recs) == Some(2);
assert Map.get({ name: "Brick", emoji: "ðŸ§±" }, recs) == Some(3);
assert Map.get({ name: "Wood", emoji: "ðŸŒ³" }, recs) == None;

// Overwriting data
let o = Map.make();

assert Map.set(1, "ðŸ‘", o) == void;
assert Map.set(1, "ðŸŒ¾", o) == void;

assert Map.get(1, o) == Some("ðŸŒ¾");

// Map.remove()

let r = Map.make();

Map.set("ðŸŒ¾", 1, r);
Map.set("ðŸ‘", 2, r);
Map.set("ðŸ§±", 3, r);

assert Map.size(r) == 3;

assert Map.remove("ðŸ‘", r) == void;

assert Map.size(r) == 2;
assert Map.get("ðŸ‘", r) == None;

assert Map.remove("ðŸŒ³", r) == void;

assert Map.size(r) == 2;

assert Map.remove("ðŸŒ¾", r) == void;
assert Map.get("ðŸŒ¾", r) == None;

assert Map.remove("ðŸ§±", r) == void;
assert Map.get("ðŸ§±", r) == None;

assert Map.isEmpty(r);

// Map.forEach()

let fe = Map.make();

Map.set(Grain, "ðŸŒ¾", fe);
Map.set(Sheep, "ðŸ‘", fe);
Map.set(Brick, "ðŸ§±", fe);

let mut called = 0;

Map.forEach((key, value) => {
  called += 1;
  match (key) {
    Grain => assert value == "ðŸŒ¾",
    Sheep => assert value == "ðŸ‘",
    Brick => assert value == "ðŸ§±",
    _ => fail "Map.forEach() should not contain this value."
  }
}, fe);

assert called == 3;

// Map.reduce()

let r = Map.make();

Map.set(Grain, 1, r);
Map.set(Sheep, 2, r);
Map.set(Brick, 3, r);

let mut called = 0;

let result = Map.reduce((acc, key, value) => {
  called += 1;
  match (key) {
    Grain => assert value == 1,
    Sheep => assert value == 2,
    Brick => assert value == 3,
    _ => fail "Map.reduce() should not contain this value."
  };
  acc + value
}, 0, r);

assert called == 3;
assert result == 6;

// Map.keys() & Map.values();

let kvs = Map.make();

Map.set(Grain, "ðŸŒ¾", kvs);
Map.set(Sheep, "ðŸ‘", kvs);
Map.set(Brick, "ðŸ§±", kvs);

let keys = Map.keys(kvs);

// No order is guaranteed
assert List.contains(Grain, keys);
assert List.contains(Sheep, keys);
assert List.contains(Brick, keys);
assert !List.contains(Wood, keys);

let vals = Map.values(kvs);

// No order is guaranteed
assert List.contains("ðŸŒ¾", vals);
assert List.contains("ðŸ‘", vals);
assert List.contains("ðŸ§±", vals);
assert !List.contains("ðŸŒ³", vals);

// Map.toList()

let tl = Map.make();

Map.set(Grain, "ðŸŒ¾", tl);
Map.set(Sheep, "ðŸ‘", tl);
Map.set(Brick, "ðŸ§±", tl);

let lis = Map.toList(tl);

// No order is guaranteed
assert List.contains((Grain, "ðŸŒ¾"), lis);
assert List.contains((Sheep, "ðŸ‘"), lis);
assert List.contains((Brick, "ðŸ§±"), lis);
assert !List.contains((Wood, "ðŸŒ³"), lis);

// Map.fromList()

let fl = Map.fromList([
  (Grain, "ðŸŒ¾"),
  (Sheep, "ðŸ‘"),
  (Brick, "ðŸ§±")
]);

assert Map.contains(Grain, fl);
assert Map.contains(Sheep, fl);
assert Map.contains(Brick, fl);
assert !Map.contains(Wood, fl);

// Map.toArray()

let ta = Map.make();

Map.set(Grain, "ðŸŒ¾", ta);
Map.set(Sheep, "ðŸ‘", ta);
Map.set(Brick, "ðŸ§±", ta);

let arr = Map.toArray(ta);

// No order is guaranteed
assert Array.contains((Grain, "ðŸŒ¾"), arr);
assert Array.contains((Sheep, "ðŸ‘"), arr);
assert Array.contains((Brick, "ðŸ§±"), arr);
assert !Array.contains((Wood, "ðŸŒ³"), arr);

// Map.fromArray()

let fa = Map.fromArray([> (Grain, "ðŸŒ¾"), (Sheep, "ðŸ‘"), (Brick, "ðŸ§±")]);

assert Map.contains(Grain, fa);
assert Map.contains(Sheep, fa);
assert Map.contains(Brick, fa);
assert !Map.contains(Wood, fa);

// Resizes the map when it grows
// TODO(#190): Don't use these internals, as they need to change after 190 is fixed

let resize = Map.makeSized(1);

// (nodeCount, bucketLength)
assert Map.getInternalStats(resize) == (0, 1);

Map.set("ðŸŒ¾", 1, resize);
Map.set("ðŸ‘", 1, resize);

// (nodeCount, bucketLength)
assert Map.getInternalStats(resize) == (2, 1);

Map.set("ðŸ§±", 1, resize);

// (nodeCount, bucketLength)
assert Map.getInternalStats(resize) == (3, 2);

// Regression tests for https://github.com/grain-lang/grain/issues/497

let largeMap = Map.fromArray(Array.init(128, i => (i, i)))

// (nodeCount, bucketLength)
assert Map.getInternalStats(largeMap) == (128, 64);

// Map.filter()

let makeFilterTestMap = () => Map.fromList([
  (Grain, "g"),
  (Sheep, "s"),
  (Brick, "b")
]);

let filterTestMap = makeFilterTestMap();

Map.filter((key, value) => key == Sheep, filterTestMap);

assert !Map.contains(Grain, filterTestMap);
assert Map.contains(Sheep, filterTestMap);
assert !Map.contains(Brick, filterTestMap);

let filterTestMap = makeFilterTestMap();

Map.filter((key, value) => value == "b" || value == "s", filterTestMap);

assert !Map.contains(Grain, filterTestMap);
assert Map.contains(Sheep, filterTestMap);
assert Map.contains(Brick, filterTestMap);

let filterTestMap = makeFilterTestMap();

Map.filter((key, value) => value == "invalid", filterTestMap);

assert Map.size(filterTestMap) == 0;

let filterTestMap = makeFilterTestMap();

Map.filter((key, value) => true, filterTestMap);

assert Map.size(filterTestMap) == 3;

// Regression tests for https://github.com/grain-lang/grain/issues/350

let makeFilterTestMap = () => {
  let map = Map.make();
  Map.set(Grain, "g", map);
  Map.set(Sheep, "s", map);
  Map.set(Brick, "b", map);
  map
}

let filterTestMap = makeFilterTestMap();

Map.filter((key, value) => key == Sheep, filterTestMap);

assert !Map.contains(Grain, filterTestMap);
assert Map.contains(Sheep, filterTestMap);
assert !Map.contains(Brick, filterTestMap);

// Map.reject()

let rejectTestMap = makeFilterTestMap();

Map.reject((key, value) => key == Sheep, rejectTestMap);

assert Map.contains(Grain, rejectTestMap);
assert !Map.contains(Sheep, rejectTestMap);
assert Map.contains(Brick, rejectTestMap);

let rejectTestMap = makeFilterTestMap();

Map.reject((key, value) => value == "b" || value == "s", rejectTestMap);

assert Map.contains(Grain, rejectTestMap);
assert !Map.contains(Sheep, rejectTestMap);
assert !Map.contains(Brick, rejectTestMap);

let rejectTestMap = makeFilterTestMap();

Map.reject((key, value) => true, rejectTestMap);

assert Map.size(rejectTestMap) == 0;

let rejectTestMap = makeFilterTestMap();

Map.reject((key, value) => false, rejectTestMap);

assert Map.size(rejectTestMap) == 3;

// Map.update()

let toUpdate = Map.fromList([("a", 1), ("b", 2), ("c", 3)]);

Map.update("b", (old) => {
  assert old == Some(2)
  Some(4)
}, toUpdate);

assert Map.get("b", toUpdate) == Some(4);

Map.update("d", (old) => {
  assert old == None
  Some(10)
}, toUpdate);

assert Map.get("d", toUpdate) == Some(10);

Map.update("c", (old) => {
  assert old == Some(3)
  None
}, toUpdate);

assert Map.contains("c", toUpdate) == false;
