module QueueTest

include "queue"
from Queue use { Immutable as ImmQ }
include "list"

// Mutable queue tests

let empty = Queue.make()
assert Queue.isEmpty(empty)
assert Queue.size(empty) == 0
assert Queue.peek(empty) == None
assert Queue.pop(empty) == None
assert Queue.size(empty) == 0

let queue = Queue.make()
Queue.push(1, queue)
Queue.push(2, queue)
Queue.push(3, queue)

assert !Queue.isEmpty(queue)
assert Queue.size(queue) == 3
assert Queue.peek(queue) == Some(1)

assert Queue.pop(queue) == Some(1)
assert Queue.peek(queue) == Some(2)
assert Queue.size(queue) == 2

Queue.push(4, queue)
assert Queue.size(queue) == 3
assert Queue.peek(queue) == Some(2)
let copy = Queue.copy(queue)
Queue.pop(copy)
assert Queue.size(copy) == 2
assert Queue.size(queue) == 3
Queue.clear(queue)
assert Queue.size(queue) == 0
assert Queue.peek(queue) == None

// test that expansion works
let queue = Queue.makeSized(3)
Queue.push(0, queue)
Queue.push(1, queue)
Queue.push(2, queue)
Queue.push(3, queue)
assert Queue.pop(queue) == Some(0)
assert Queue.pop(queue) == Some(1)
assert Queue.pop(queue) == Some(2)
assert Queue.pop(queue) == Some(3)
assert Queue.pop(queue) == None

// test that the "circular" behavior of the circular queue works as expected
let queue = Queue.makeSized(4)
let push = x => () => Queue.push(x, queue)
let pop = () => ignore(Queue.pop(queue))
let actions = [
  push(1),
  push(2),
  push(3),
  push(4),
  pop,
  pop,
  pop,
  push(5),
  push(6),
  pop,
  pop,
  push(7),
  push(8),
  push(9),
]
List.forEach(action => action(), actions)

assert Queue.size(queue) == 4
assert Queue.peek(queue) == Some(6)

Queue.push(10, queue)
assert Queue.size(queue) == 5
assert Queue.pop(queue) == Some(6)
assert Queue.pop(queue) == Some(7)
assert Queue.pop(queue) == Some(8)
assert Queue.pop(queue) == Some(9)
assert Queue.pop(queue) == Some(10)
assert Queue.pop(queue) == None

// Immutable queue tests

// 1 <- 2 <- 3
let sampleQueue = ImmQ.push(3, ImmQ.push(2, ImmQ.push(1, ImmQ.empty)))

// ImmQ.isEmpty

assert ImmQ.isEmpty(ImmQ.empty)
assert !ImmQ.isEmpty(sampleQueue)

// ImmQ.peek

assert ImmQ.peek(ImmQ.empty) == None
assert ImmQ.peek(sampleQueue) == Some(1)

// ImmQ.push

assert ImmQ.peek(ImmQ.push(1, ImmQ.empty)) == Some(1)
assert ImmQ.peek(ImmQ.push(4, sampleQueue)) == Some(1)

// ImmQ.pop

assert ImmQ.isEmpty(ImmQ.pop(ImmQ.empty))
assert ImmQ.isEmpty(ImmQ.pop(ImmQ.push(1, ImmQ.empty)))
assert ImmQ.isEmpty(ImmQ.pop(ImmQ.pop(ImmQ.pop(sampleQueue))))
assert ImmQ.peek(ImmQ.pop(sampleQueue)) == Some(2)
assert ImmQ.peek(ImmQ.pop(ImmQ.push(4, ImmQ.pop(sampleQueue)))) == Some(3)

// ImmQ.size

assert ImmQ.size(ImmQ.empty) == 0
assert ImmQ.size(sampleQueue) == 3
assert ImmQ.size(ImmQ.pop(ImmQ.pop(sampleQueue))) == 1
